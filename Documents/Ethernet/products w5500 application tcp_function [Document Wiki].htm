<!DOCTYPE html>
<html dir="ltr" class="js desktop" lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>products:w5500:application:tcp_function [Document Wiki]</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki">
<meta name="robots" content="index,follow">
<meta name="keywords" content="products,w5500,application,tcp_function">
<link rel="search" type="application/opensearchdescription+xml" href="https://wizwiki.net/wiki/lib/exe/opensearch.php" title="&lt;h1&gt;Document Wiki&lt;/h1&gt;">
<link rel="start" href="https://wizwiki.net/wiki/">
<link rel="contents" href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:tcp_function&amp;do=index" title="Sitemap">
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="https://wizwiki.net/wiki/feed.php">
<link rel="alternate" type="application/rss+xml" title="Current namespace" href="https://wizwiki.net/wiki/feed.php?mode=list&amp;ns=products:w5500:application">
<link rel="alternate" type="text/html" title="Plain HTML" href="https://wizwiki.net/wiki/doku.php?do=export_xhtml&amp;id=products:w5500:application:tcp_function">
<link rel="alternate" type="text/plain" title="Wiki Markup" href="https://wizwiki.net/wiki/doku.php?do=export_raw&amp;id=products:w5500:application:tcp_function">
<link rel="canonical" href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:tcp_function">
<link rel="stylesheet" type="text/css" href="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/css.css">
<!--[if gte IE 9]><!-->
<script type="text/javascript">/*<![CDATA[*/var NS='products:w5500:application';var JSINFO = {"id":"products:w5500:application:tcp_function","namespace":"products:w5500:application","plugin_folded":{"hide":"hide","reveal":"reveal"},"isadmin":0,"isauth":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/jquery.php"></script>
<script type="text/javascript" charset="utf-8" src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/js.php"></script><style type="text/css" media="screen"><!--/*--><![CDATA[/*><!--*/ .folded.hidden { display: none; } .folder .indicator { visibility: visible; } /*]]>*/--></style><style id="iris-css">.iris-picker{display:block;position:relative}.iris-picker,.iris-picker *{-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}input+.iris-picker{margin-top:4px}.iris-error{background-color:#ffafaf}.iris-border{border-radius:3px;border:1px solid #aaa;width:200px;background-color:#fff}.iris-picker-inner{position:absolute;top:0;right:0;left:0;bottom:0}.iris-border .iris-picker-inner{top:10px;right:10px;left:10px;bottom:10px}.iris-picker .iris-square-inner{position:absolute;left:0;right:0;top:0;bottom:0}.iris-picker .iris-square,.iris-picker .iris-slider,.iris-picker .iris-square-inner,.iris-picker .iris-palette{border-radius:3px;box-shadow:inset 0 0 5px rgba(0,0,0,.4);height:100%;width:12.5%;float:left;margin-right:5%}.iris-picker .iris-square{width:76%;margin-right:10%;position:relative}.iris-picker .iris-square-inner{width:auto;margin:0}.iris-ie-9 .iris-square,.iris-ie-9 .iris-slider,.iris-ie-9 .iris-square-inner,.iris-ie-9 .iris-palette{box-shadow:none;border-radius:0}.iris-ie-9 .iris-square,.iris-ie-9 .iris-slider,.iris-ie-9 .iris-palette{outline:1px solid rgba(0,0,0,.1)}.iris-ie-lt9 .iris-square,.iris-ie-lt9 .iris-slider,.iris-ie-lt9 .iris-square-inner,.iris-ie-lt9 .iris-palette{outline:1px solid #aaa}.iris-ie-lt9 .iris-square .ui-slider-handle{outline:1px solid #aaa;background-color:#fff;-ms-filter:"alpha(Opacity=30)"}.iris-ie-lt9 .iris-square .iris-square-handle{background:0;border:3px solid #fff;-ms-filter:"alpha(Opacity=50)"}.iris-picker .iris-strip{margin-right:0;position:relative}.iris-picker .iris-strip .ui-slider-handle{position:absolute;background:0;margin:0;right:-3px;left:-3px;border:4px solid #aaa;border-width:4px 3px;width:auto;height:6px;border-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,.2);opacity:.9;z-index:5;cursor:ns-resize}.iris-strip .ui-slider-handle:before{content:" ";position:absolute;left:-2px;right:-2px;top:-3px;bottom:-3px;border:2px solid #fff;border-radius:3px}.iris-picker .iris-slider-offset{position:absolute;top:11px;left:0;right:0;bottom:-3px;width:auto;height:auto;background:transparent;border:0;border-radius:0}.iris-picker .iris-square-handle{background:transparent;border:5px solid #aaa;border-radius:50%;border-color:rgba(128,128,128,.5);box-shadow:none;width:12px;height:12px;position:absolute;left:-10px;top:-10px;cursor:move;opacity:1;z-index:10}.iris-picker .ui-state-focus .iris-square-handle{opacity:.8}.iris-picker .iris-square-handle:hover{border-color:#999}.iris-picker .iris-square-value:focus .iris-square-handle{box-shadow:0 0 2px rgba(0,0,0,.75);opacity:.8}.iris-picker .iris-square-handle:hover::after{border-color:#fff}.iris-picker .iris-square-handle::after{position:absolute;bottom:-4px;right:-4px;left:-4px;top:-4px;border:3px solid #f9f9f9;border-color:rgba(255,255,255,.8);border-radius:50%;content:" "}.iris-picker .iris-square-value{width:8px;height:8px;position:absolute}.iris-ie-lt9 .iris-square-value,.iris-mozilla .iris-square-value{width:1px;height:1px}.iris-palette-container{position:absolute;bottom:0;left:0;margin:0;padding:0}.iris-border .iris-palette-container{left:10px;bottom:10px}.iris-picker .iris-palette{margin:0;cursor:pointer}.iris-square-handle,.ui-slider-handle{border:0;outline:0}</style>
<!--<![endif]-->
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="shortcut icon" href="https://wizwiki.net/wiki/lib/exe/fetch.php?media=favicon.ico">
<link rel="apple-touch-icon" href="https://wizwiki.net/wiki/lib/tpl/dokuwiki/images/apple-touch-icon.png">
    </head>

<body>
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_dokuwiki    showSidebar hasSidebar">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header"><div class="pad group">

    
    <div class="headings group">
        <ul class="a11y skip">
            <li><a href="#dokuwiki__content">skip to content</a></li>
        </ul>

        <h1><a href="https://wizwiki.net/wiki/doku.php?id=start" accesskey="h" title="[H]"><img src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/fetch.png" alt="" width="190" height="70"> <span><h1>Document Wiki</h1></span></a></h1>
            </div>

    <div class="tools group">
        <!-- USER TOOLS -->
                    <div id="dokuwiki__usertools">
                <h3 class="a11y">User Tools</h3>
                <ul>
                    <li><a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:tcp_function&amp;do=login&amp;sectok=" class="action login" rel="nofollow" title="Log In">Log In</a></li>                </ul>
            </div>
        
        <!-- SITE TOOLS -->
        <div id="dokuwiki__sitetools">
            <h3 class="a11y">Site Tools</h3>
            <form action="/wiki/doku.php?id=start" accept-charset="utf-8" class="search" id="dw__search" method="get" role="search"><div class="no"><input name="do" value="search" type="hidden"><input placeholder="Search" id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" type="text"><button type="submit" title="Search">Search</button><div id="qsearch__out" class="ajax_qsearch JSpopup" style="display: none;"></div></div></form>            <div class="mobileTools">
                <form action="/wiki/doku.php" method="get" accept-charset="utf-8"><div class="no"><input name="id" value="products:w5500:application:tcp_function" type="hidden"><select name="do" class="edit quickselect" title="Tools"><option value="" selected="selected">Tools</option><optgroup label="Page Tools"><option value="edit">Show pagesource</option><option value="revisions">Old revisions</option><option value="backlink">Backlinks</option></optgroup><optgroup label="Site Tools"><option value="recent">Recent Changes</option><option value="media">Media Manager</option><option value="index">Sitemap</option></optgroup><optgroup label="User Tools"><option value="login">Log In</option></optgroup></select><button type="submit" style="display: none;">&gt;</button></div></form>            </div>
            <ul>
                <li><a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:tcp_function&amp;do=recent" class="action recent" accesskey="r" rel="nofollow" title="Recent Changes [R]">Recent Changes</a></li><li><a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:tcp_function&amp;do=media&amp;ns=products%3Aw5500%3Aapplication" class="action media" rel="nofollow" title="Media Manager">Media Manager</a></li><li><a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:tcp_function&amp;do=index" class="action index" accesskey="x" rel="nofollow" title="Sitemap [X]">Sitemap</a></li>            </ul>
        </div>

    </div>

    <!-- BREADCRUMBS -->
            <div class="breadcrumbs">
                                        <div class="trace"><span class="bchead">Trace:</span> <span class="bcsep">•</span> <span class="curid"><bdi><a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:tcp_function" class="breadcrumbs" title="products:w5500:application:tcp_function">tcp_function</a></bdi></span></div>
                    </div>
    


    <hr class="a11y">
</div></div><!-- /header -->

        <div class="wrapper group">

                            <!-- ********** ASIDE ********** -->
                <div id="dokuwiki__aside"><div class="pad aside include group">
                    <h3 class="toggle open" style="cursor: pointer; display: none;"><strong><span>−</span></strong>Sidebar</h3>
                    <div class="content" style="" aria-expanded="true"><div class="group">
                                                                        <ul>
<li class="level1 node"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products" class="wikilink1" title="products">Products</a>    </div>
<ul>
<li class="level2"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:imcu:start" class="wikilink1" title="products:imcu:start">iMCU</a></div>
</li>
<li class="level2"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:preprogrammed_mcu:start" class="wikilink1" title="products:preprogrammed_mcu:start">Pre-programmed MCU</a></div>
</li>
<li class="level2 node"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:iethernet:start" class="wikilink1" title="products:iethernet:start">iEthernet</a></div>
<ul>
<li class="level3"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5100s:start" class="wikilink1" title="products:w5100s:start">W5100S</a></div>
</li>
<li class="level3 node"><div class="li"> <strong><a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:start" class="wikilink1" title="products:w5500:start">W5500</a></strong></div>
<ul>
<li class="level4"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:start" class="wikilink1" title="products:w5500:start">Overview</a></div>
</li>
<li class="level4"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:datasheet" class="wikilink1" title="products:w5500:datasheet">Datasheet</a></div>
</li>
<li class="level4"><div class="li"> <span class="curid"><a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:driver" class="wikilink1" title="products:w5500:driver">Driver</a></span>     </div>
</li>
<li class="level4"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:refschematic" class="wikilink1" title="products:w5500:refschematic">Ref. Schematic</a></div>
</li>
<li class="level4"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:migration" class="wikilink1" title="products:w5500:migration">Migration from W5200</a></div>
</li>
<li class="level4 node"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application" class="wikilink1" title="products:w5500:application">Application</a></div>
<ul>
<li class="level5"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:tcp_function" class="wikilink1" title="products:w5500:application:tcp_function">TCP</a></div>
</li>
<li class="level5"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:udp_function" class="wikilink1" title="products:w5500:application:udp_function">UDP</a></div>
</li>
<li class="level5"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:ipraw" class="wikilink1" title="products:w5500:application:ipraw">IPRAW</a></div>
</li>
<li class="level5"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:pppoe" class="wikilink1" title="products:w5500:application:pppoe">PPPoE</a></div>
</li>
</ul>
</li>
<li class="level4"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:esd" class="wikilink1" title="products:w5500:esd">ESD Test Document</a></div>
</li>
<li class="level4"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:allpages" class="wikilink1" title="products:w5500:allpages">All Pages</a></div>
</li>
<li class="level4"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:w5500_evb:start" class="wikilink1" title="products:w5500:w5500_evb:start">W5500-EVB</a>   </div>
</li>
</ul>
</li>
<li class="level3"><div class="li"> <a href="http://www.wiznet.io/product-item/w5300/" class="urlextern" title="http://www.wiznet.io/product-item/w5300/" rel="nofollow">W5300</a></div>
</li>
<li class="level3"><div class="li"> <a href="http://www.wiznet.io/product-item/w5100/" class="urlextern" title="http://www.wiznet.io/product-item/w5100/" rel="nofollow">W5100</a></div>
</li>
<li class="level3"><div class="li"> <a href="http://www.wiznet.io/product-item/w3150a+/" class="urlextern" title="http://www.wiznet.io/product-item/w3150a+/" rel="nofollow">W3150A+</a></div>
</li>
</ul>
</li>
<li class="level2"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:s2e_module:start" class="wikilink1" title="products:s2e_module:start">S2E Module</a></div>
</li>
<li class="level2"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:io_module:start" class="wikilink1" title="products:io_module:start">ioModule</a></div>
</li>
<li class="level2"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:app_module:start" class="wikilink1" title="products:app_module:start">App Module</a></div>
</li>
<li class="level2"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:wifi_module:start" class="wikilink1" title="products:wifi_module:start">Wi-Fi Module</a></div>
</li>
<li class="level2"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=products:wizwiki_module:start" class="wikilink1" title="products:wizwiki_module:start">Mbed WIZwiki Platform</a></div>
</li>
<li class="level2"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=osh:start" class="wikilink1" title="osh:start">Open Source Hardware</a></div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=design_guide:start" class="wikilink1" title="design_guide:start">Design Guide</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://wizwiki.net/wiki/doku.php?id=oshw_using_wiznet:start" class="wikilink1" title="oshw_using_wiznet:start">VAR Products using WIZnet</a></div>
</li>
</ul>
                                            </div></div>
                </div></div><!-- /aside -->
            
            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">
                
                <div class="pageId"><span>products:w5500:application:tcp_function</span></div>

                <div class="page group" style="min-height: 523.083px;">
                                                            <!-- wikipage start -->
                    <!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle open" style="cursor: pointer;"><strong><span>−</span></strong>Table of Contents</h3>
<div style="" aria-expanded="true">

<ul class="toc">
<li class="level1"><div class="li"><a href="#w5500_tcp_function">W5500 TCP Function</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#initialization">Initialization</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="#basic_setting">Basic Setting</a></div></li>
<li class="level3"><div class="li"><a href="#setting_network_information">Setting network information</a></div></li>
<li class="level3"><div class="li"><a href="#set_socket_memory_information">Set socket memory information</a></div></li>
</ul>
</li>
<li class="level2"><div class="li"><a href="#data_communications">Data Communications</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="#tcp">TCP</a></div></li>
<li class="level3"><div class="li"><a href="#tcp_server">TCP SERVER</a></div></li>
<li class="level3"><div class="li"><a href="#tcp_client">TCP CLIENT</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="w5500_tcp_function">W5500 TCP Function</h1>
<div class="level1">

<p>
By setting some register and memory operation, W5500 provides internet connectivity.
This chapter describes how it can be operated.
</p>

</div>

<h2 class="sectionedit2" id="initialization">Initialization</h2>
<div class="level2">
<div class="wrap_round wrap_center wrap_tip wrap_centeralign plugin_wrap" style="width: 80%;">
<p>
You <strong>must check PHY LINK</strong> <em>(0 bit of PHYCFGR)</em> <strong>before attempting to make a network connection</strong> using sockets.
</p>
</div>
</div>

<h3 class="sectionedit5" id="basic_setting">Basic Setting</h3>
<div class="level3">

<p>
For the W5500 operation, select and utilize appropriate registers shown below.
</p>
<ol>
<li class="level1"><div class="li"> Mode Register (MR)</div>
</li>
<li class="level1"><div class="li"> Interrupt Mask Register (IMR)</div>
</li>
<li class="level1"><div class="li"> Retry Time-value Register (RTR)</div>
</li>
<li class="level1"><div class="li"> Retry Count Register (RCR)</div>
</li>
</ol>

<p>
For more information of above registers, refer to the “Register Descriptions.”
</p>

</div>

<h3 class="sectionedit6" id="setting_network_information">Setting network information</h3>
<div class="level3">

<p>
Basic network information setting for communication:
It must be set the basic network information.
</p>
<ol>
<li class="level1 node"><div class="li"> SHAR(Source Hardware Address Register)</div>
<ul>
<li class="level2"><div class="li"> It is prescribed that the source 
hardware addresses, which is set by SHAR, use unique hardware addresses 
(Ethernet MAC address) in the Ethernet MAC layer. The IEEE manages the 
MAC address allocation. The manufacturer which produces the network 
device allocates the MAC address to product.</div>
</li>
<li class="level2"><div class="li"> Details on MAC address allocation refer to the website as below.</div>
</li>
<li class="level2"><div class="li"> <a href="http://www.ieee.org/" class="urlextern" title="http://www.ieee.org/" rel="nofollow">http://www.ieee.org/</a></div>
</li>
<li class="level2"><div class="li"> <a href="http://standards.ieee.org/regauth/oui/index.shtml" class="urlextern" title="http://standards.ieee.org/regauth/oui/index.shtml" rel="nofollow">http://standards.ieee.org/regauth/oui/index.shtml</a></div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> GAR(Gateway Address Register)</div>
</li>
<li class="level1"><div class="li"> SUBR(Subnet Mask Register)</div>
</li>
<li class="level1"><div class="li"> SIPR(Source IP Address Register)</div>
</li>
</ol>

</div>

<h3 class="sectionedit7" id="set_socket_memory_information">Set socket memory information</h3>
<div class="level3">

<p>
This stage sets the socket tx/rx memory information. The base address 
and mask address of each socket are fixed and saved in this stage.
</p>

<p><b><em>In case of, assign 2KB rx, tx memroy per SOCKET</em></b></p>
<pre class="code c">In <span class="kw1">case</span> of<span class="sy0">,</span> assign 2KB rx<span class="sy0">,</span> tx memory per SOCKET
<span class="br0">{</span>
Sn_RXMEM_SIZE<span class="br0">(</span>ch<span class="br0">)</span> <span class="sy0">=</span> <span class="br0">(</span><span class="kw4">uint8</span> <span class="sy0">*</span><span class="br0">)</span> <span class="nu0">2</span><span class="sy0">;</span> <span class="co1">// Assign 2K rx memory per SOCKET</span>
Sn_TXMEM_SIZE<span class="br0">(</span>ch<span class="br0">)</span> <span class="sy0">=</span> <span class="br0">(</span><span class="kw4">uint8</span> <span class="sy0">*</span><span class="br0">)</span> <span class="nu0">2</span><span class="sy0">;</span> <span class="co1">// Assign 2K rx memory per SOCKET</span>
&nbsp;
<span class="coMULTI">/* Same method, set gS1_TX_BASE, gS1_TX_MASK, gS2_TX_BASE, gS2_TX_MASK,
gS3_TX_BASE, gS3_TX_MASK, gS4_TX_BASE, gS4_TX_MASK, gS5_TX_BASE, gS5_TX_MASK,
gS6_TX_BASE, gS6_tx_MASK, gS7_TX_BASE, gS7_TX_MASK */</span>
<span class="br0">}</span></pre>

</div>

<h2 class="sectionedit8" id="data_communications">Data Communications</h2>
<div class="level2">

<p>
After the initialization process, W5500 can transmit and receive the 
data with others by ‘open’ the SOCKET of TCP, UDP, IPRAW, and MACRAW 
mode. The W5500 supports the independently and simultaneously usable 8 
SOCKETS. In this section, the communication method for each mode will be
 introduced.
</p>

</div>

<h3 class="sectionedit9" id="tcp">TCP</h3>
<div class="level3">

<p>
The TCP is a connection-oriented protocol. The TCP make the connection 
SOCKET by
using its own IP address, port number and destination IP address, port 
number. Then transmits and receives the data by using this SOCKET.
Methods of making the connection to SOCKET are “TCP SERVER” and “TCP 
CLIENT”. It
is divided by transmitting the connect-request (SYN packet). The “TCP 
SERVER” listens to the connect-request from the “TCP CLIENT”, and makes 
connection SOCKET by accepting the transmitted connect-request 
(Passive-open).
The “TCP CLIENT” transmits the connect-request first to “TCP SERVER” to 
make the
connection (Active-open).
</p>

<p>
<a href="https://wizwiki.net/wiki/lib/exe/detail.php?id=products%3Aw5500%3Aapplication%3Atcp_function&amp;media=products:w5500:application:serverclient.jpg" class="media" title="products:w5500:application:serverclient.jpg"><img src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/fetch_002.jpg" class="media" title="TCP SERVER and TCP CLIENT" alt="TCP SERVER and TCP CLIENT"></a>
</p>

</div>

<h3 class="sectionedit10" id="tcp_server">TCP SERVER</h3>
<div class="level3">

<p>
<a href="https://wizwiki.net/wiki/lib/exe/detail.php?id=products%3Aw5500%3Aapplication%3Atcp_function&amp;media=products:w5500:application:server_flow.jpg" class="media" title="products:w5500:application:server_flow.jpg"><img src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/fetch.jpg" class="media" title="TCP SERVER Operation Flow" alt="TCP SERVER Operation Flow"></a>
</p>

</div>

<h5 id="socket_initialization">SOCKET Initialization</h5>
<div class="level5">

<p>
SOCKET initialization is required for TCP data communication. The 
initialization is opening the SOCKET. The SOCKET opening process selects
 one SOCKET from 8 SOCKETS of the W5500, and sets the protocol mode 
(Sn_MR) and Sn_PORT0 which is source port number (Listen port number in 
“TCP SERVER”) in the selected SOCKET, and then executes OPEN command. 
After the OPEN command, if the status of Sn_SR is changed to SOCK_INIT, 
the SOCKET initialization process is completed.
The SOCKET initialization process is identically applied in “TCP SERVER”
 and “TCP CLIENT.”The Initialization process of Socket n in TCP mode is 
shown below.
</p>
<pre class="code c"><span class="br0">{</span>
START<span class="sy0">:</span>
Sn_MR <span class="sy0">=</span> <span class="nu12">0x01</span><span class="sy0">;</span> <span class="co1">// sets TCP mode</span>
Sn_PORT0 <span class="sy0">=</span> source_port<span class="sy0">;</span> <span class="co1">// sets source port number</span>
Sn_CR <span class="sy0">=</span> OPEN<span class="sy0">;</span> <span class="co1">// sets OPEN command</span>
<span class="coMULTI">/* wait until Sn_SR is changed to SOCK_INIT */</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_SR <span class="sy0">!=</span> SOCK_INIT<span class="br0">)</span> Sn_CR <span class="sy0">=</span> CLOSE<span class="sy0">;</span> <span class="kw1">goto</span> START<span class="sy0">;</span>
<span class="br0">}</span></pre>
<div class="wrap_round wrap_center wrap_tip wrap_centeralign plugin_wrap" style="width: 80%;">
<p>
After W5500 <strong>accepts the command, the Sn_CR register is
automatically cleared to 0x00</strong>. Even though Sn_CR is cleared to 0x00, the command is
still being processed. <em>To check whether the command is completed or not, please
check the Sn_IR or Sn_SR.</em>
</p>
</div>
</div>

<h5 id="listen">LISTEN</h5>
<div class="level5">

<p>
Run as “TCP SERVER” by LISTEN command.
</p>
<pre class="code c"><span class="br0">{</span>
<span class="coMULTI">/* listen SOCKET */</span>
Sn_CR <span class="sy0">=</span> LISTEN<span class="sy0">;</span>
<span class="coMULTI">/* wait until Sn_SR is changed to SOCK_LISTEN */</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_SR <span class="sy0">!=</span> SOCK_LISTEN<span class="br0">)</span> Sn_CR <span class="sy0">=</span> CLOSE<span class="sy0">;</span> <span class="kw1">goto</span> START<span class="sy0">;</span>
<span class="br0">}</span></pre>

</div>

<h5 id="establishment">ESTABLISHMENT</h5>
<div class="level5">

<p>
When the status of Sn_SR is SOCK_LISTEN, if it receives a SYN packet, 
the status of Sn_SR is changed to SOCK_SYNRECV and transmits the SYN/ACK
 packet. After that, the Socket n makes a connection. After it makes the
 connection of Socket n , it enables the data communication. There are 
two methods to confirm the connection of Socket n .
</p>
<pre class="code c">First method <span class="sy0">:</span>
<span class="br0">{</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_IR<span class="br0">(</span>CON<span class="br0">)</span> <span class="sy0">==</span> ‘<span class="nu0">1</span>’<span class="br0">)</span>
<span class="coMULTI">/* When an interrupt occurs and the mask bit of Sn_IMR is ‘1’, the interrupt bit of Sn_IR
becomes ‘1’ */</span>
Sn_IR<span class="br0">(</span>CON<span class="br0">)</span> <span class="sy0">=</span> ‘<span class="nu0">1</span>’<span class="sy0">;</span>
<span class="coMULTI">/*In order to clear the Sn_IR bit, the host should write the bit as ‘1’. When all the bits of
Sn_IR is cleared (‘0’), IR(n) is automatically cleared.*/</span>
<span class="kw1">goto</span> ESTABLISHED stage<span class="sy0">;</span>
<span class="coMULTI">/* In this case, if the interrupt of Socket n is activated, interrupt occurs. Refer to IR, IMR
Sn_IMR and Sn_IR. */</span>
<span class="br0">}</span>
Second method <span class="sy0">:</span>
<span class="br0">{</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_SR <span class="sy0">==</span> SOCK_ESTABLISHED<span class="br0">)</span> <span class="kw1">goto</span> ESTABLISHED stage<span class="sy0">;</span>
<span class="br0">}</span></pre>

</div>

<h5 id="establishmentcheck_received_data">ESTABLISHMENT : Check received data</h5>
<div class="level5">

<p>
Confirm the reception of the TCP data.
</p>
<pre class="code c">First method <span class="sy0">:</span>
<span class="br0">{</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_IR<span class="br0">(</span>RECV<span class="br0">)</span> <span class="sy0">==</span> ‘<span class="nu0">1</span>’<span class="br0">)</span> Sn_IR<span class="br0">(</span>RECV<span class="br0">)</span> <span class="sy0">=</span> ‘<span class="nu0">1</span>’<span class="sy0">;</span> <span class="kw1">goto</span> Receiving Process stage<span class="sy0">;</span>
<span class="coMULTI">/* In this case, if the interrupt of Socket n is activated, interrupt occurs. Refer to IR, IMR
Sn_IMR and Sn_IR. */</span>
<span class="br0">}</span>
Second Method <span class="sy0">:</span>
<span class="br0">{</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_RX_RSR0 <span class="sy0">!=</span> <span class="nu12">0x0000</span><span class="br0">)</span> <span class="kw1">goto</span> Receiving Process stage<span class="sy0">;</span>
<span class="br0">}</span></pre>

<p>
The First method: set the Sn_IR(RECV) to ‘1’ whenever you receive a DATA
 packet. If the host receives the next DATA packet without setting the 
Sn_IR(RECV) as ‘1’ in the prior DATA packet, it cannot recognize the 
Sn_IR(RECV) of the next DATA packet. This is due to the prior 
Sn_IR(RECV) and next Sn_IR(RECV) being overlapped. So this method is not
 recommended if the host cannot perfectly process the DATA packets of 
each Sn_IR(RECV).
</p>

</div>

<h5 id="establishmentreceiving_process">ESTABLISHMENT : Receiving process</h5>
<div class="level5">

<p>
In this process, it processes the TCP data which was received in the 
Internal RX
memory. At the TCP mode, the W5500 cannot receive the data if the size 
of received data is larger than the RX memory free size of Socket n . If
 the prior stated condition is happened, the W5500 holds on to the 
connection (pauses), and waits until the RX memory’s free size is larger
 than the size of the received data.
</p>
<pre class="code c"><span class="br0">{</span>
<span class="coMULTI">/* first, get the received size */</span>
len <span class="sy0">=</span> Sn_RX_RSR<span class="sy0">;</span> <span class="co1">// len is received size</span>
<span class="coMULTI">/* select RX memory, refer to Datasheet 14 page */</span>
cntl_byte <span class="sy0">=</span> Socket_n_RX_Buffer 
<span class="coMULTI">/* Get offset address */</span>
src_ptr <span class="sy0">=</span> Sn_RX_RD<span class="sy0">;</span>
<span class="coMULTI">/* set memory copy len bytes of source_ptr to destination_address */</span>
<span class="kw1">for</span> <span class="br0">(</span>i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>len<span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span>
<span class="br0">{</span>
   <span class="sy0">*</span><span class="br0">(</span>dst_ptr<span class="sy0">+</span>i<span class="br0">)</span> <span class="sy0">=</span> W5500_READ<span class="br0">(</span>addr<span class="sy0">,</span> cntl_byte<span class="sy0">,</span> src_ptr<span class="sy0">+</span>i<span class="br0">)</span><span class="sy0">;</span>
<span class="br0">}</span>
<span class="coMULTI">/* increase Sn_RX_RD as length of len */</span>
Sn_RX_RD <span class="sy0">+=</span> len<span class="sy0">;</span>
<span class="coMULTI">/* set RECV command */</span>
Sn_CR <span class="sy0">=</span> RECV<span class="sy0">;</span>
<span class="br0">}</span></pre>

</div>

<h5 id="establishmentcheck_send_data_send_process">ESTABLISHMENT: Check send data / Send process</h5>
<div class="level5">

<p>
The size of the transmit data cannot be larger than assigned internal TX
 memory of Socket n. If the size of transmit data is larger than 
configured MSS, it is divided by size of MSS and transmits. To transmit 
the next data, user must check the completion of prior SEND command. An 
error may occur if the SEND command executes before completion of prior 
SEND command. The larger the data size, the more time to complete the 
SEND command. So the user should properly divide the data to transmit.<br>

To check the completion of the SEND command, it should be check that the
 send data length is equal with the actual sent data length. The actual 
sent data length is calculated by the difference of the Sn_TX_RD before 
and after performing the SEND command. If the actual sent data is less 
than the send data length, the SEND command is retried for sending the 
left data. The send process is therefore completed the SENDwhen the sum 
of the actual sent data is equal the send data length. A simple example 
of the send process is as below<br>

Ex) Send Data Length Size= 10,<br>

</p>
<ol>
<li class="level1"><div class="li"> <strong>Execute SEND Command with send data length</strong></div>
</li>
<li class="level1 node"><div class="li"> <strong>Calculate the actual sent data length</strong></div>
<ul>
<li class="level2"><div class="li"> If the actual sent data length is 7 (= Sn_TX_RD_after_SEND-Sn_TX_RD_befor_SEND),</div>
</li>
<li class="level2"><div class="li"> the left Data length= 3</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <strong>Retry SEND Command until the sum of the actual sent data length is same the send data length.</strong><br>
</div>
</li>
</ol>

<p>
Note: Don’t copy data until the sum of the actual sent data length is the send data length.
</p>
<pre class="code c"><span class="br0">{</span>
<span class="coMULTI">/* first, get the free TX memory size */</span>
FREESIZE<span class="sy0">:</span>
freesize <span class="sy0">=</span> Sn_TX_FSR<span class="sy0">;</span>
<span class="kw1">if</span> <span class="br0">(</span>freesize<span class="sy0">&lt;</span>len<span class="br0">)</span> <span class="kw1">goto</span> FREESIZE<span class="sy0">;</span> <span class="co1">// len is send size</span>
&nbsp;
<span class="coMULTI">/* select TX memory, refer to Datasheet 14 page */</span>
cntl_byte <span class="sy0">=</span> Socket_n_TX_Buffer 
<span class="coMULTI">/* Get offset address */</span>
dst_ptr <span class="sy0">=</span> Sn_TX_RD<span class="sy0">;</span>
<span class="coMULTI">/* set memory copy len bytes of source_ptr to destination_address */</span>
<span class="kw1">for</span> <span class="br0">(</span>i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>len<span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span>
<span class="br0">{</span>
   W5500_WRITE<span class="br0">(</span>addr<span class="sy0">,</span> cntl_byte<span class="sy0">,</span> dst_ptr<span class="sy0">+</span>i<span class="br0">)</span><span class="sy0">;</span>
<span class="br0">}</span>
&nbsp;
<span class="coMULTI">/* increase Sn_TX_WR as length of len */</span>
Sn_TX_WR <span class="sy0">+=</span> send_size<span class="sy0">;</span>
<span class="coMULTI">/* set SEND command */</span>
Sn_CR <span class="sy0">=</span> SEND<span class="sy0">;</span>
<span class="coMULTI">/* return real packet size */</span>
<span class="kw1">return</span> len<span class="sy0">;</span>
<span class="br0">}</span></pre>

</div>

<h5 id="establishmentcheck_disconnect-request_fin_packet">ESTABLISHMENT : Check disconnect-request(FIN packet)</h5>
<div class="level5">

<p>
Check if the Disconnect-request(FIN packet) has been received. User can confirm the reception of FIN packet as below.
</p>
<pre class="code c">First method <span class="sy0">:</span>
<span class="br0">{</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_IR<span class="br0">(</span>DISCON<span class="br0">)</span> <span class="sy0">==</span> ‘<span class="nu0">1</span>’<span class="br0">)</span> Sn_IR<span class="br0">(</span>DISCON<span class="br0">)</span><span class="sy0">=</span>‘<span class="nu0">1</span>’<span class="sy0">;</span> <span class="kw1">goto</span> CLOSED stage<span class="sy0">;</span>
<span class="coMULTI">/* In this case, if the interrupt of Socket n is activated, interrupt occurs. Refer to IR, IMR
Sn_IMR and Sn_IR. */</span>
<span class="br0">}</span>
Second method <span class="sy0">:</span>
<span class="br0">{</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_SR <span class="sy0">==</span> SOCK_CLOSE_WAIT<span class="br0">)</span> <span class="kw1">goto</span> CLOSED stage<span class="sy0">;</span>
<span class="br0">}</span></pre>

</div>

<h5 id="establishmentcheck_disconnect_disconnecting_process">ESTABLISHMENT : Check disconnect / disconnecting process</h5>
<div class="level5">

<p>
When the user does not need data communication with others, or receives a FIN
packet, disconnect the connection SOCKET.
</p>
<pre class="code c"><span class="br0">{</span>
<span class="coMULTI">/* set DISCON command */</span>
Sn_CR <span class="sy0">=</span> DISCON<span class="sy0">;</span>
<span class="br0">}</span></pre>

</div>

<h5 id="establishmentcheck_closed">ESTABLISHMENT : Check closed</h5>
<div class="level5">

<p>
Confirm that the Socket n is disconnected or closed by DISCON or close command.
</p>
<pre class="code c">First method <span class="sy0">:</span>
<span class="br0">{</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_IR<span class="br0">(</span>DISCON<span class="br0">)</span> <span class="sy0">==</span> ‘<span class="nu0">1</span>’<span class="br0">)</span> <span class="kw1">goto</span> CLOSED stage<span class="sy0">;</span>
<span class="coMULTI">/* In this case, if the interrupt of Socket n is activated, interrupt occurs. Refer to IR, IMR
Sn_IMR and Sn_IR. */</span>
<span class="br0">}</span>
Second method <span class="sy0">:</span>
<span class="br0">{</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_SR <span class="sy0">==</span> SOCK_CLOSED<span class="br0">)</span> <span class="kw1">goto</span> CLOSED stage<span class="sy0">;</span>
<span class="br0">}</span></pre>

</div>

<h5 id="establishmenttimeout">ESTABLISHMENT: Timeout</h5>
<div class="level5">

<p>
The timeout can occur by Connect-request(SYN packet) or its 
response(SYN/ACK packet), the DATA packet or its response(DATA/ACK 
packet), the Disconnectrequest 
FIN packet) or its response(FIN/ACK packet) and transmission all TCP 
packet. If it cannot transmit the above packets within ‘timeout’ which 
is configured at RTR and RCR, the TCP final timeout(TCP<sub>TO</sub>) occurs and the state of Sn_SR is set to SOCK_CLOSED. Confirming method of the TCP<sub>TO</sub> is as below:
</p>
<pre class="code c">First method <span class="sy0">:</span>
<span class="br0">{</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_IR<span class="br0">(</span>TIMEOUT bit<span class="br0">)</span> <span class="sy0">==</span> ‘<span class="nu0">1</span>’<span class="br0">)</span> Sn_IR<span class="br0">(</span>TIMEOUT<span class="br0">)</span><span class="sy0">=</span>‘<span class="nu0">1</span>’<span class="sy0">;</span> <span class="kw1">goto</span> CLOSED stage<span class="sy0">;</span>
<span class="coMULTI">/* In this case, if the interrupt of Socket n is activated, interrupt occurs. Refer to IR, IMR
Sn_IMR and Sn_IR. */</span>
<span class="br0">}</span>
Second method <span class="sy0">:</span>
<span class="br0">{</span>
<span class="kw1">if</span> <span class="br0">(</span>Sn_SR <span class="sy0">==</span> SOCK_CLOSED<span class="br0">)</span> <span class="kw1">goto</span> CLOSED stage<span class="sy0">;</span>
<span class="br0">}</span></pre>

</div>

<h5 id="socket_close">SOCKET Close</h5>
<div class="level5">

<p>
It can be used to close the Socket n , which disconnected by disconnect-process, or closed by TCP<sub>TO</sub> or closed by host’s need without disconnect-process.
</p>
<pre class="code c"><span class="br0">{</span>
<span class="coMULTI">/* clear the remained interrupts of Socket n */</span>
Sn_IR <span class="sy0">=</span> <span class="nu12">0xFF</span><span class="sy0">;</span>
IR<span class="br0">(</span>n<span class="br0">)</span> <span class="sy0">=</span> ‘<span class="nu0">1</span>’<span class="sy0">;</span>
<span class="coMULTI">/* set CLOSE command */</span>
Sn_CR <span class="sy0">=</span> CLOSE<span class="sy0">;</span>
<span class="br0">}</span></pre>

</div>

<h3 class="sectionedit13" id="tcp_client">TCP CLIENT</h3>
<div class="level3">

<p>
It is same as TCP server except ‘CONNECT’ state. User can refer to the above “TCP SERVER” section.
</p>

<p>
<a href="https://wizwiki.net/wiki/lib/exe/detail.php?id=products%3Aw5500%3Aapplication%3Atcp_function&amp;media=products:w5500:application:client_flow.jpg" class="media" title="products:w5500:application:client_flow.jpg"><img src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/fetch_003.jpg" class="media" title="TCP CLIENT Operation Flow" alt="TCP CLIENT Operation Flow"></a>
</p>

</div>

<h5 id="connect">CONNECT</h5>
<div class="level5">

<p>
Transmit the connect-request (SYN packet) to “TCP SERVER”. It may occurs the
timeout such as ARP<sub>TO</sub>, TCP<sub>TO</sub> when make the “connection SOCKET” with “TCP SERVER”
</p>
<pre class="code c"><span class="br0">{</span>
Sn_DIPR0 <span class="sy0">=</span> server_ip<span class="sy0">;</span> <span class="coMULTI">/* set TCP SERVER IP address*/</span>
Sn_DPORT0 <span class="sy0">=</span> server_port<span class="sy0">;</span> <span class="coMULTI">/* set TCP SERVER listen port number*/</span>
Sn_CR <span class="sy0">=</span> CONNECT<span class="sy0">;</span> <span class="coMULTI">/* set CONNECT command */</span>
<span class="br0">}</span></pre>

</div>

                    <!-- wikipage stop -->
                                    </div>

                <div class="docInfo"><bdi>products/w5500/application/tcp_function.txt</bdi> · Last modified: 2017/05/18 10:16 by <bdi>kei</bdi></div>

                            </div></div><!-- /content -->

            <hr class="a11y">

            <!-- PAGE ACTIONS -->
            <div id="dokuwiki__pagetools">
                <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li><a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:tcp_function&amp;do=edit" class="action source" accesskey="v" rel="nofollow" title="Show pagesource [V]"><span>Show pagesource</span></a></li><li><a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:tcp_function&amp;do=revisions" class="action revs" accesskey="o" rel="nofollow" title="Old revisions [O]"><span>Old revisions</span></a></li><li><a href="https://wizwiki.net/wiki/doku.php?id=products:w5500:application:tcp_function&amp;do=backlink" class="action backlink" rel="nofollow" title="Backlinks"><span>Backlinks</span></a></li><li><a href="#dokuwiki__top" class="action top" accesskey="t" rel="nofollow" title="Back to top [T]"><span>Back to top</span></a></li>                    </ul>
                </div>
            </div>
        </div><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer"><div class="pad">
    <div class="license">Except where otherwise noted, content on this wiki is licensed under the following license: <bdi><a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license" class="urlextern">CC Attribution-Share Alike 4.0 International</a></bdi></div>
    <div class="buttons">
        <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license"><img src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/cc-by-sa.png" alt="CC Attribution-Share Alike 4.0 International"></a>        <a href="http://www.dokuwiki.org/donate" title="Donate"><img src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/button-donate.gif" alt="Donate" width="80" height="15"></a>
        <a href="http://php.net/" title="Powered by PHP"><img src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/button-php.gif" alt="Powered by PHP" width="80" height="15"></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5"><img src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/button-html5.png" alt="Valid HTML5" width="80" height="15"></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS"><img src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/button-css.png" alt="Valid CSS" width="80" height="15"></a>
        <a href="http://dokuwiki.org/" title="Driven by DokuWiki"><img src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/button-dw.png" alt="Driven by DokuWiki" width="80" height="15"></a>
    </div>
</div></div><!-- /footer -->

    </div></div><!-- /site -->

    <div class="no"><img src="products%20w5500%20application%20tcp_function%20[Document%20Wiki]_files/indexer.gif" alt="" width="2" height="1"></div>
    <div id="screen__mode" class="no"></div>

</body></html>